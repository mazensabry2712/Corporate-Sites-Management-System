# ูุธุงู ุญุณุงุจ PR Invoices Total Value ุงูุชููุงุฆู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู **ุญุณุงุจ ุชููุงุฆู** ููุฌููุน ููู ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจููุณ ุฑูู ุงููุดุฑูุน (PR_NUMBER).

---

## โ๏ธ ููู ูุนูู ุงููุธุงู

### 1. ุนูุฏ **ุฅุถุงูุฉ** ูุงุชูุฑุฉ ุฌุฏูุฏุฉ (`store`)
```php
// ูุญุณุจ ูุฌููุน ุฌููุน ุงูููุงุชูุฑ ุงูุณุงุจูุฉ ูููุณ PR_NUMBER
$existingTotal = invoices::where('pr_number', $data['pr_number'])->sum('value');

// ูุถูู ูููุฉ ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ
$data['pr_invoices_total_value'] = $existingTotal + $data['value'];

// ุจุนุฏ ุงูุญูุธุ ูุญุฏุซ ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจููุณ PR_NUMBER
$newTotal = invoices::where('pr_number', $data['pr_number'])->sum('value');
invoices::where('pr_number', $data['pr_number'])
    ->update(['pr_invoices_total_value' => $newTotal]);
```

### 2. ุนูุฏ **ุชุนุฏูู** ูุงุชูุฑุฉ (`update`)
```php
// ูุญูุธ ุฑูู ุงููุดุฑูุน ุงููุฏูู (ูู ุญุงูุฉ ุชุบููุฑ PR_NUMBER)
$oldPrNumber = $invoices->pr_number;

// ุจุนุฏ ุงูุชุญุฏูุซุ ูุนูุฏ ุญุณุงุจ ุงููุฌููุน ูููุดุฑูุน ุงูุฌุฏูุฏ
$newTotal = invoices::where('pr_number', $data['pr_number'])->sum('value');
invoices::where('pr_number', $data['pr_number'])
    ->update(['pr_invoices_total_value' => $newTotal]);

// ุฅุฐุง ุชุบูุฑ PR_NUMBERุ ูุนูุฏ ุญุณุงุจ ุงููุฌููุน ูููุดุฑูุน ุงููุฏูู ุฃูุถุงู
if ($oldPrNumber != $data['pr_number']) {
    $oldTotal = invoices::where('pr_number', $oldPrNumber)->sum('value');
    invoices::where('pr_number', $oldPrNumber)
        ->update(['pr_invoices_total_value' => $oldTotal]);
}
```

### 3. ุนูุฏ **ุญุฐู** ูุงุชูุฑุฉ (`destroy`)
```php
// ูุญูุธ ุฑูู ุงููุดุฑูุน ูุจู ุงูุญุฐู
$prNumber = $invoice->pr_number;

// ุจุนุฏ ุงูุญุฐูุ ูุนูุฏ ุญุณุงุจ ุงููุฌููุน ููููุงุชูุฑ ุงููุชุจููุฉ
$newTotal = invoices::where('pr_number', $prNumber)->sum('value');
invoices::where('pr_number', $prNumber)
    ->update(['pr_invoices_total_value' => $newTotal]);
```

---

## ๐ ูุซุงู ุนููู

### ุงูุณููุงุฑูู:
ูุฏูู ูุดุฑูุน **PR #1 - mazen sabry**

#### ุงูุฎุทูุฉ 1: ุฅุถุงูุฉ ุฃูู ูุงุชูุฑุฉ
- Invoice #7: Value = **5,000**
- ุงููุชูุฌุฉ: `pr_invoices_total_value` = **5,000**

#### ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ ูุงุชูุฑุฉ ุซุงููุฉ
- Invoice #645: Value = **456,456**
- ุงููุชูุฌุฉ: 
  - Invoice #7: `pr_invoices_total_value` = **461,456** (5,000 + 456,456)
  - Invoice #645: `pr_invoices_total_value` = **461,456**

#### ุงูุฎุทูุฉ 3: ุฅุถุงูุฉ ูุงุชูุฑุฉ ุซุงูุซุฉ
- Invoice #999: Value = **10,000**
- ุงููุชูุฌุฉ:
  - **ุฌููุน ุงูููุงุชูุฑ** ุงูุซูุงุซุฉ: `pr_invoices_total_value` = **471,456** (5,000 + 456,456 + 10,000)

#### ุงูุฎุทูุฉ 4: ุญุฐู ูุงุชูุฑุฉ
- ุญุฐู Invoice #999 (Value = 10,000)
- ุงููุชูุฌุฉ:
  - Invoice #7: `pr_invoices_total_value` = **461,456**
  - Invoice #645: `pr_invoices_total_value` = **461,456**

---

## โ ุงูููุฒุงุช

1. **ุญุณุงุจ ุชููุงุฆู 100%**: ูุง ุญุงุฌุฉ ูุฅุฏุฎุงู ูุฏูู
2. **ุชุญุฏูุซ ููุฑู**: ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุชูุญุฏุซ ุชููุงุฆูุงู
3. **ุฏุนู ุชุบููุฑ PR_NUMBER**: ุนูุฏ ููู ูุงุชูุฑุฉ ููุดุฑูุน ุขุฎุฑุ ููุนุงุฏ ุญุณุงุจ ุงููุฌููุน ูููุดุฑูุนูู
4. **ุฏูุฉ ุนุงููุฉ**: ุงุณุชุฎุฏุงู `sum()` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ
5. **ูุณุญ Cache ุชููุงุฆู**: ูุถูุงู ุธููุฑ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ููุฑุงู

---

## ๐ ุงูุงุฎุชุจุงุฑ

ุชู ุฅูุดุงุก ุณูุฑูุจุชูู ููุงุฎุชุจุงุฑ:

### 1. `test_invoice_total.php`
- ูุฎุชุจุฑ ุตุญุฉ ุงูุญุณุงุจุงุช
- ูุนุฑุถ ุญุงูุฉ ุฌููุน ุงูููุงุชูุฑ
- ูุชุญูู ูู ุชุทุงุจู ุงูููู

### 2. `fix_invoice_totals.php`
- ูุตูุญ ุงูููุงุชูุฑ ุงููุฏููุฉ (ุงูููุฌูุฏุฉ ูุจู ุงูุชุทููุฑ)
- ูุญุฏุซ `pr_invoices_total_value` ูุฌููุน ุงูููุงุชูุฑ
- ุชู ุชุดุบููู ูุฑุฉ ูุงุญุฏุฉ ูุญุฏูุซ **5 ููุงุชูุฑ** ุจูุฌุงุญ โ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### Controller
- `app/Http/Controllers/InvoicesController.php`
  - โ `store()` - ุฅุถุงูุฉ ูุงุชูุฑุฉ
  - โ `update()` - ุชุนุฏูู ูุงุชูุฑุฉ  
  - โ `destroy()` - ุญุฐู ูุงุชูุฑุฉ

### Model
- `app/Models/invoices.php`
  - ุงูุญูู `pr_invoices_total_value` ููุฌูุฏ ูู `$fillable`

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

```
โ ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจููุณ PR_NUMBER ููุง ููุณ ูููุฉ ุงููุฌููุน
โ ุงูุชุญุฏูุซ ุชููุงุฆู ุนูุฏ: ุฅุถุงูุฉ / ุชุนุฏูู / ุญุฐู
โ ุฏุนู ุชุบููุฑ PR_NUMBER
โ ุชู ุงุฎุชุจุงุฑ ุงููุธุงู ุจูุฌุงุญ
โ 5 ููุงุชูุฑ ููุฌูุฏุฉ ุชู ุชุญุฏูุซูุง ุจูุฌุงุญ
```

---

## ๐ง ุงูุตูุงูุฉ

ุฅุฐุง ุงุญุชุฌุช ูุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงูููู ูู ุงููุณุชูุจู:
```bash
php fix_invoice_totals.php
```

---

## ๐ ููุงุญุธุงุช

- ุงููุธุงู ูุนูู **ุชููุงุฆูุงู** - ูุง ุญุงุฌุฉ ูุฃู ุฅุฌุฑุงุก ูุฏูู
- ุฌููุน ุงูุนูููุงุช **ุขููุฉ** ููุญููุฉ ุจู validation
- ุงูู **Cache ูููุณุญ ุชููุงุฆูุงู** ุจุนุฏ ูู ุนูููุฉ
- ุงููุธุงู ูุฏุนู **unlimited invoices** ูููุณ ุงููุดุฑูุน

---

**ุชู ุงูุชุทููุฑ ูุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ** โ
**ุงูุชุงุฑูุฎ:** 15 ุฃูุชูุจุฑ 2025
